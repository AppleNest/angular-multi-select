var angular_multi_select=angular.module("angular-multi-select",["ng","angular.filter"]);
angular_multi_select.directive("angularMultiSelect",["$sce","$timeout","$filter","$interpolate",function(e,k,f,g){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"angular-multi-select.htm",link:function(a,p,b){b.itemLabel=b.itemLabel||"";b.idProperty=b.idProperty||"angular-multi-select-id";b.selectionMode=b.selectionMode||"multi";
b.selectionMode=b.selectionMode.toLowerCase();b.helperElements=b.helperElements||"reset filter";b.searchProperty=b.searchProperty||"";b.hiddenProperty=b.hiddenProperty||"";b.minSearchLength=parseInt(b.minSearchLength,10)||3;a._shadowModel=[];a.filteredModel=[];a.searchInput={value:""};a.kbFocus=[];a.kbFocusIndex=null;a.visible=!1;a.buttonLabel="";a.tickProperty=b.tickProperty;a.idProperty=b.idProperty;a.groupProperty=b.groupProperty;a.itemLabel=b.itemLabel;a.hiddenProperty=b.hiddenProperty;a.icon=
{selectAll:"&#10003;",selectNone:"&times;",reset:"&#8630;",tickMark:e.trustAsHtml("&#10003;")};a._trans={selectAll:"Select all",selectNone:"Select none",reset:"Reset",search:"Search..."};angular.extend(a._trans,a.translation);a.lang={selectAll:e.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;"+a._trans.selectAll),selectNone:e.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;"+a._trans.selectNone),reset:e.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;"+a._trans.reset),search:a._trans.search};a.helperStatus={all:-1!==
b.helperElements.search(new RegExp(/\ball\b/))?!0:-1!==b.helperElements.search(new RegExp(/\bnoall\b/))?!1:"multi"===b.selectionMode,none:-1!==b.helperElements.search(new RegExp(/\bnone\b/))?!0:-1!==b.helperElements.search(new RegExp(/\bnonone\b/))?!1:"multi"===b.selectionMode,reset:-1!==b.helperElements.search(new RegExp(/\breset\b/))?!0:-1===b.helperElements.search(new RegExp(/\bnoreset\b/)),filter:-1!==b.helperElements.search(new RegExp(/\bfilter\b/))?!0:-1===b.helperElements.search(new RegExp(/\bnofilter\b/))};
a.not=function(a){return function(b){return!a(b)}};a._walk=function(b,d,h){if(angular.isArray(b)){var l=[];angular.forEach(b,function(b){b=a._walk(b,d,h);null!==b&&l.push(b)});return 0<l.length?l:null}if(angular.isObject(b)){h=h||function(){return!0};var m=h(b);if(b.hasOwnProperty(d)&&angular.isArray(b[d])){var e=[];angular.forEach(b[d],function(b){b=a._walk(b,d,h);null!==b&&e.push(b)});e.length!==b[d].length&&(b[d]=e);m=0<e.length}return m?b:null}};a._syncModels=function(c,d){a._walk(d,b.groupProperty,
function(d){a._walk(c,b.groupProperty,function(a){a[b.idProperty]===d[b.idProperty]&&(a[b.tickProperty]=d[b.tickProperty]);return!0});return!0})};a._enforceIDs=function(c){var d=[];a._walk(c,b.groupProperty,function(a){if(!1===a.hasOwnProperty(b.idProperty)||-1!==d.indexOf(a[b.idProperty]))a[b.idProperty]=Math.floor(1E8*Math.random()+1);d.push(a[b.idProperty]);return!0})};a._getParent=function(c,d){var h=null,e=!1,m=null;a._walk(c,b.groupProperty,function(c){if(!0===e)return!0;0<a._hasChildren(c,
!1)&&c[b.idProperty]!==d[b.idProperty]&&(m=c);c[b.idProperty]===d[b.idProperty]&&(h=m,e=!0);return!0});return h};a._getLeafs=function(c){var d=[];a._walk(c,b.groupProperty,function(b){0===a._hasChildren(b,!1)&&d.push(b);return!0});return d};a._getNodes=function(c){var d=[];a._walk(c,b.groupProperty,function(b){0<a._hasChildren(b,!1)&&d.push(b);return!0});return d};a._createLabel=function(a){var d=b.itemLabel,d=d.replace(/\{\|/g,"{{"),d=d.replace(/\|\}/g,"}}");a=g(d)(a);return e.trustAsHtml(a)};a._hasChildren=
function(c,d){if(!1===(d||!1)&&c.hasOwnProperty(b.groupProperty)&&angular.isArray(c[b.groupProperty])&&0<c[b.groupProperty].length)return 1;var e=-1;a._walk(c,b.groupProperty,function(){e++;return!0});return e};a._isHidden=function(a){return!(!a.hasOwnProperty(b.hiddenProperty)||!0!==a[b.hiddenProperty])};a._isChecked=function(a){return!(!a.hasOwnProperty(b.tickProperty)||!0!==a[b.tickProperty])};a._areAllChecked=function(c){var d=0,e=0;a._walk(c,b.groupProperty,function(b){0===a._hasChildren(b,!1)&&
(a._isChecked(b)&&d++,e++);return!0});return e===d?d:0<d?-d:0};a._enforceChecks=function(c){var d=0,e=a._getLeafs(c),l=!1;angular.forEach(e,function(e){!0!==l&&(a._isChecked(e)&&d++,1<d&&"single"===b.selectionMode&&(l=!0,a._uncheckAll(c)))});!0!==l&&(e=a._getNodes(c),angular.forEach(e,function(d){d[b.tickProperty]=0!==a._areAllChecked(d)}))};a._flipCheck=function(c){if(0<a._hasChildren(c)){var d=!(0<a._areAllChecked(c));a._walk(c,b.groupProperty,function(a){a[b.tickProperty]=d;return!0})}else c[b.tickProperty]=
!a._isChecked(c)};a._uncheckAll=function(c){a._walk(c,b.groupProperty,function(a){a[b.tickProperty]=!1;return!0})};a._checkAll=function(c){a._walk(c,b.groupProperty,function(a){return a[b.tickProperty]=!0})};a.clickItem=function(c,d){!0===d&&(a.kbFocusIndex=null);"single"!==b.selectionMode||0===a._areAllChecked(a._shadowModel)||(0===a._hasChildren(c,!1)||1===a._hasChildren(c))&&a._isChecked(c)||(a._uncheckAll(a._shadowModel),a._uncheckAll(a.filteredModel));a._flipCheck(c);a._enforceChecks(a.filteredModel);
a.onItemClick({item:angular.copy(c)})};a._filter=function(c){if(""===b.searchProperty||void 0===a.searchInput.value||""===a.searchInput.value)return!0;c=angular.extend({},c);c[b.searchProperty]=f("latinize")(c[b.searchProperty]);var d=a.searchInput.value,d=f("latinize")(d);return 0<f("fuzzyBy")([c],b.searchProperty,d).length};a.fillShadowModel=function(){a._shadowModel=angular.copy(a.inputModel);a._enforceIDs(a._shadowModel);a._enforceChecks(a._shadowModel);a.fillFilteredModel()};a.selectAll=function(){a._checkAll(a.filteredModel);
a.onSelectAll()};a.selectNone=function(){a._uncheckAll(a.filteredModel);a.onSelectNone()};a.reset=function(){a.onReset();a.fillShadowModel()};a.clear=function(){a.searchInput.value="";a.onClear()};a.fillFilteredModel=function(){a.filteredModel=angular.copy(a._shadowModel);a.filteredModel=a._walk(a.filteredModel,b.groupProperty,a._filter)};a.$watch("inputModel",function(b,d){!b&&angular.equals(b,d)||a.fillShadowModel()},!0);a.$watch("filteredModel",function(c){c&&(c=Math.abs(a._areAllChecked(a.filteredModel)),
a.buttonLabel=c+" selected",a.buttonLabel=e.trustAsHtml(a.buttonLabel+'<span class="caret"></span>'),a._syncModels(a._shadowModel,a.filteredModel),a.outputModel=a._walk(angular.copy(a._shadowModel),b.groupProperty,function(d){a.kbFocus.push(d[b.idProperty]);return a._isChecked(d)}),a.kbFocus=[],!0===a.helperStatus.all&&a.kbFocus.push("all"),!0===a.helperStatus.none&&a.kbFocus.push("none"),!0===a.helperStatus.reset&&a.kbFocus.push("reset"),!0===a.helperStatus.filter&&(a.kbFocus.push("input"),a.kbFocus.push("clear")),
a._walk(a.filteredModel,b.groupProperty,function(d){a.kbFocus.push(d[b.idProperty]);return!0}))},!0);a.$watch("searchInput.value",function(c,d){if(!angular.equals(c,d)){if(c.length>b.minSearchLength||c.length<d.length&&0<=d.length)a.kbFocusIndex=null,a.fillFilteredModel();a.onSearchChange({input:c})}});a.$watch("visible",function(c,d){angular.equals(c,d)||!0!==c?angular.equals(c,d)||!1!==c||(a.stopListeningMouseEvents(),a.stopListeningMouseEvents=null,a.stopListeningKeyboardEvents(),a.stopListeningKeyboardEvents=
null,a.onClose()):(a.kbFocusIndex=a.kbFocus.indexOf("input")||0,a.stopListeningMouseEvents=a.$on("angular-multi-select-click",function(b,d){var c=!1;angular.forEach($(d.event.target).parents(),function(a){!0!==c&&void 0!==$(a).attr("angular-multi-select")&&(c=!0)});!1===c&&(a.visible=!1,a.$apply())}),a.stopListeningKeyboardEvents=a.$on("angular-multi-select-keydown",function(d,c){var e=c.event.keyCode?c.event.keyCode:c.event.which,f=a.kbFocusIndex,g=!1;if(27===e)a.visible=!1;else if(13===e||32===
e){var n=a.kbFocus[a.kbFocusIndex];angular.isNumber(n)&&a._walk(a.filteredModel,b.groupProperty,function(c){c[b.idProperty]===n&&a.clickItem(c);return!0})}else 40===e||39===e||!c.event.shiftKey&&9==e?(null===a.kbFocusIndex&&(a.kbFocusIndex=-1),a.kbFocusIndex<a.kbFocus.length-1?a.kbFocusIndex++:a.kbFocusIndex=0):38===e||37===e||c.event.shiftKey&&9==e?(null===a.kbFocusIndex&&(a.kbFocusIndex=1),0<a.kbFocusIndex?a.kbFocusIndex--:a.kbFocusIndex=a.kbFocus.length-1):g=!0;a.$apply();!0===g&&k(function(){a.kbFocusIndex=
f},0)}),a.onOpen())})}}}]);angular_multi_select.directive("angularMultiSelectKeyTrap",function(){return function(e,k){k.bind("keydown",function(f){e.$broadcast("angular-multi-select-keydown",{event:f})})}});angular_multi_select.directive("angularMultiSelectMouseTrap",function(){return function(e,k){k.bind("click",function(f){e.$broadcast("angular-multi-select-click",{event:f})})}});
angular_multi_select.directive("setFocus",function(e){return function(k,f,g){g.setFocus=g.setFocus||!1;k.$watch(g.setFocus,function(a){e(function(){a?f.focus():f.blur()})},!0)}});angular_multi_select.run(["$templateCache",function(e){e.put("angular-multi-select-item.htm","<div class='multiSelectItem' ng-click='clickItem(item, true);' ng-class='{selected: item[tickProperty], multiSelectGroup:_hasChildren(item, false) > 0, multiSelectFocus: kbFocus[kbFocusIndex] === item[idProperty]}'><div ng-bind-html='_createLabel(item)'></div><span class='tickMark' ng-if='item[tickProperty] === true' ng-bind-html='icon.tickMark'></span></div><ul ng-if='item.sub'><li ng-repeat='item in item[groupProperty] | filter: not(_isHidden)' ng-include=\"'angular-multi-select-item.htm'\" ></li></ul>")}]);
angular_multi_select.run(["$templateCache",function(e){e.put("angular-multi-select.htm",'<span class="multiSelect inlineBlock"><button type="button" ng-click="visible = !visible" ng-bind-html="buttonLabel"></button><div class="checkboxLayer" ng-show="visible"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.all" ng-click="selectAll()" ng-bind-html="lang.selectAll" set-focus="kbFocus[kbFocusIndex] === \'all\'""></button><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.none" ng-click="selectNone()" ng-bind-html="lang.selectNone" set-focus="kbFocus[kbFocusIndex] === \'none\'"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled" ng-if="helperStatus.reset" ng-click="reset()" ng-bind-html="lang.reset" set-focus="kbFocus[kbFocusIndex] === \'reset\'"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{ lang.search }}" type="text"ng-model="searchInput.value" class="inputFilter" set-focus="kbFocus[kbFocusIndex] === \'input\'"/><button type="button" class="clearButton" ng-click="clear()" set-focus="kbFocus[kbFocusIndex] === \'clear\'">\u00d7</button> </div> </div> <div class="checkBoxContainer"><ul><li ng-repeat=\'item in filteredModel | filter: not(_isHidden)\' ng-include="\'angular-multi-select-item.htm\'"></li></ul></div></div></div></span>')}]);
