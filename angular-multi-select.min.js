var angular_multi_select=angular.module("angular-multi-select",["ng","angular.filter"]);
angular_multi_select.directive("angularMultiSelect",["$sce","$timeout","$filter","$interpolate",function(e,h,f,m){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"angular-multi-select.htm",link:function(a,n,b){a._shadowModel=[];a.filteredModel=[];a.searchInput={value:""};b.idProperty=b.idProperty||"angular-multi-select-id";b.selectionMode=b.selectionMode||
"multi";b.selectionMode=b.selectionMode.toLowerCase();var p=b.helperElements||"";b.helperElements+=""===p?"reset ":"";b.helperElements+=""===p?"filter ":"";a.helperStatus={all:-1!==b.helperElements.search(new RegExp(/\ball\b/))?!0:-1!==b.helperElements.search(new RegExp(/\bnoall\b/))?!1:"multi"===b.selectionMode,none:-1!==b.helperElements.search(new RegExp(/\bnone\b/))?!0:-1!==b.helperElements.search(new RegExp(/\bnonone\b/))?!1:"multi"===b.selectionMode,reset:-1!==b.helperElements.search(new RegExp(/\breset\b/))?
!0:-1!==b.helperElements.search(new RegExp(/\bnoreset\b/)),filter:-1!==b.helperElements.search(new RegExp(/\bfilter\b/))?!0:-1!==b.helperElements.search(new RegExp(/\bnofilter\b/))};a.kbFocus=[];a.kbFocusIndex=null;a.visible=!1;a.buttonLabel="";a.tickProperty=b.tickProperty;a.idProperty=b.idProperty;a.groupProperty=b.groupProperty;a.itemLabel=b.itemLabel;a._walk=function(b,d,g){if(angular.isArray(b)){var k=[];angular.forEach(b,function(b){b=a._walk(b,d,g);null!==b&&k.push(b)});return 0<k.length?k:
null}if(angular.isObject(b)){g=g||function(){return!0};var l=g(b);if(b.hasOwnProperty(d)&&angular.isArray(b[d])){var e=[];angular.forEach(b[d],function(b){b=a._walk(b,d,g);null!==b&&e.push(b)});e.length!==b[d].length&&(b[d]=e);l=0<e.length}return l?b:null}};a._syncModels=function(c,d){a._walk(d,b.groupProperty,function(d){a._walk(c,b.groupProperty,function(a){a[b.idProperty]===d[b.idProperty]&&(a[b.tickProperty]=d[b.tickProperty]);return!0});return!0})};a._enforceIDs=function(c){var d=[];a._walk(c,
b.groupProperty,function(a){if(!1===a.hasOwnProperty(b.idProperty)||-1!==d.indexOf(a[b.idProperty]))a[b.idProperty]=Math.floor(1E8*Math.random()+1);d.push(a[b.idProperty]);return!0})};a._getParent=function(c,d){var g=null,e=!1,l=null;a._walk(c,b.groupProperty,function(c){if(!0===e)return!0;0<a._hasChildren(c,!1)&&c[b.idProperty]!==d[b.idProperty]&&(l=c);c[b.idProperty]===d[b.idProperty]&&(g=l,e=!0);return!0});return g};a._getLeafs=function(c){var d=[];a._walk(c,b.groupProperty,function(b){0===a._hasChildren(b,
!1)&&d.push(b);return!0});return d};a._getNodes=function(c){var d=[];a._walk(c,b.groupProperty,function(b){0<a._hasChildren(b,!1)&&d.push(b);return!0});return d};a._createLabel=function(a){var d=b.itemLabel,d=d.replace(/\{\|/g,"{{"),d=d.replace(/\|\}/g,"}}");a=m(d)(a);return e.trustAsHtml(a)};a._hasChildren=function(c,d){if(!1===(d||!1)&&c.hasOwnProperty(b.groupProperty)&&angular.isArray(c[b.groupProperty])&&0<c[b.groupProperty].length)return 1;var e=-1;a._walk(c,b.groupProperty,function(){e++;return!0});
return e};a._isChecked=function(a){return!(!a.hasOwnProperty(b.tickProperty)||!0!==a[b.tickProperty])};a._areAllChecked=function(c){var d=0,e=0;a._walk(c,b.groupProperty,function(b){0===a._hasChildren(b,!1)&&(a._isChecked(b)&&d++,e++);return!0});return e===d?d:0<d?-d:0};a._enforceChecks=function(c){var d=0,e=a._getLeafs(c),k=!1;angular.forEach(e,function(e){!0!==k&&(a._isChecked(e)&&d++,1<d&&"single"===b.selectionMode&&(k=!0,a._uncheckAll(c)))});!0!==k&&(e=a._getNodes(c),angular.forEach(e,function(d){d[b.tickProperty]=
0!==a._areAllChecked(d)}))};a._flipCheck=function(c){if(0<a._hasChildren(c)){var d=!(0<a._areAllChecked(c));a._walk(c,b.groupProperty,function(a){a[b.tickProperty]=d;return!0})}else c[b.tickProperty]=!a._isChecked(c)};a._uncheckAll=function(c){a._walk(c,b.groupProperty,function(a){a[b.tickProperty]=!1;return!0})};a._checkAll=function(c){a._walk(c,b.groupProperty,function(a){return a[b.tickProperty]=!0})};a.clickItem=function(c,d){d&&(a.kbFocusIndex=null);"single"!==b.selectionMode||0===a._areAllChecked(a._shadowModel)||
(0===a._hasChildren(c,!1)||1===a._hasChildren(c))&&a._isChecked(c)||(a._uncheckAll(a._shadowModel),a._uncheckAll(a.filteredModel));a._flipCheck(c);a._enforceChecks(a.filteredModel);h(function(){a.onItemClick({data:angular.copy(c)})},0)};a._filter=function(c){if(void 0===a.searchInput.value||""===a.searchInput.value)return!0;c=angular.extend({},c);c[b.itemLabel]=f("latinize")(c[b.itemLabel]);var d=a.searchInput.value,d=f("latinize")(d);return 0<f("fuzzyBy")([c],b.itemLabel,d).length};a.fillShadowModel=
function(){a._shadowModel=angular.copy(a.inputModel);a._enforceIDs(a._shadowModel);a._enforceChecks(a._shadowModel);a.fillFilteredModel()};a.fillFilteredModel=function(){a.filteredModel=angular.copy(a._shadowModel);a.filteredModel=a._walk(a.filteredModel,b.groupProperty,a._filter)};a.$watch("filteredModel",function(c){c&&(c=Math.abs(a._areAllChecked(a.filteredModel)),a.buttonLabel=c+" selected",a.buttonLabel=e.trustAsHtml(a.buttonLabel+'<span class="caret"></span>'),a._syncModels(a._shadowModel,a.filteredModel),
a.outputModel=a._walk(angular.copy(a._shadowModel),b.groupProperty,function(d){a.kbFocus.push(d[b.idProperty]);return a._isChecked(d)}),a.kbFocus=[],!0===a.helperStatus.all&&a.kbFocus.push("all"),!0===a.helperStatus.none&&a.kbFocus.push("none"),!0===a.helperStatus.reset&&a.kbFocus.push("reset"),!0===a.helperStatus.filter&&(a.kbFocus.push("input"),a.kbFocus.push("clear")),a._walk(a.filteredModel,b.groupProperty,function(d){a.kbFocus.push(d[b.idProperty]);return!0}))},!0);a.$watch("searchInput.value",
function(b,d){angular.equals(b,d)||(a.kbFocusIndex=null,a.fillFilteredModel())});a.$watch("visible",function(c,d){angular.equals(c,d)||!0!==c?angular.equals(c,d)||!1!==c||(a.stopListeningMouseEvents(),a.stopListeningMouseEvents=null,a.stopListeningKeyboardEvents(),a.stopListeningKeyboardEvents=null):(a.kbFocusIndex=a.kbFocus.indexOf("input")||0,a.stopListeningMouseEvents=a.$on("angular-multi-select-click",function(b,d){var c=!1;angular.forEach($(d.event.target).parents(),function(a){!0!==c&&void 0!==
$(a).attr("angular-multi-select")&&(c=!0)});!1===c&&(a.visible=!1,a.$apply())}),a.stopListeningKeyboardEvents=a.$on("angular-multi-select-keydown",function(d,c){var e=c.event.keyCode?c.event.keyCode:c.event.which;if(27===e)a.visible=!1;else if(13===e||32===e){var f=a.kbFocus[a.kbFocusIndex];angular.isNumber(f)&&a._walk(a.filteredModel,b.groupProperty,function(c){c[b.idProperty]===f&&a.clickItem(c);return!0})}else if(40===e||39===e||!c.event.shiftKey&&9==e)null===a.kbFocusIndex&&(a.kbFocusIndex=-1),
a.kbFocusIndex<a.kbFocus.length-1?a.kbFocusIndex++:a.kbFocusIndex=0;else if(38===e||37===e||c.event.shiftKey&&9==e)null===a.kbFocusIndex&&(a.kbFocusIndex=1),0<a.kbFocusIndex?a.kbFocusIndex--:a.kbFocusIndex=a.kbFocus.length-1;a.$apply()}))});a.fillShadowModel();a.lang={};"undefined"!==typeof b.maxHeight&&(n=n.children().children().children()[0],angular.element(n).attr("style","height:"+b.maxHeight+"; overflow-y:scroll;"));a.icon={};a.icon.selectAll="&#10003;";a.icon.selectNone="&times;";a.icon.reset=
"&#8630;";a.icon.tickMark="&#10003;";"undefined"!==typeof b.translation?(a.lang.selectAll=e.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;"+a.translation.selectAll),a.lang.selectNone=e.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;"+a.translation.selectNone),a.lang.reset=e.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;"+a.translation.reset),a.lang.search=a.translation.search,a.lang.nothingSelected=e.trustAsHtml(a.translation.nothingSelected)):(a.lang.selectAll=e.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;Select All"),
a.lang.selectNone=e.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;Select None"),a.lang.reset=e.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;Reset"),a.lang.search="Search...",a.lang.nothingSelected="None Selected");a.icon.tickMark=e.trustAsHtml(a.icon.tickMark)}}}]);angular_multi_select.directive("angularMultiSelectKeyTrap",function(){return function(e,h){h.bind("keydown",function(f){e.$broadcast("angular-multi-select-keydown",{event:f})})}});
angular_multi_select.directive("angularMultiSelectMouseTrap",function(){return function(e,h){h.bind("click",function(f){e.$broadcast("angular-multi-select-click",{event:f})})}});angular_multi_select.directive("setFocus",function(e){return function(h,f,m){h.$watch(m.setFocus,function(a){e(function(){a?f.focus():f.blur()})},!0)}});angular_multi_select.run(["$templateCache",function(e){e.put("angular-multi-select-item.htm","<div class='multiSelectItem' ng-click='clickItem(item, true);' ng-class='{selected: item[tickProperty], multiSelectGroup:_hasChildren(item, false) > 0, multiSelectFocus: kbFocus[kbFocusIndex] === item[idProperty]}'><div ng-bind-html='_createLabel(item)'></div><span class='tickMark' ng-if='item[tickProperty] === true' ng-bind-html='icon.tickMark'></span></div><ul ng-if='item.sub'><li ng-repeat='item in item[groupProperty]' ng-include=\"'angular-multi-select-item.htm'\" ></li></ul>")}]);
angular_multi_select.run(["$templateCache",function(e){e.put("angular-multi-select.htm",'<span class="multiSelect inlineBlock"><button type="button" ng-click="visible = !visible" ng-bind-html="buttonLabel"></button><div class="checkboxLayer" ng-show="visible"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.all" ng-click="_checkAll(filteredModel)" ng-bind-html="lang.selectAll" set-focus="kbFocus[kbFocusIndex] === \'all\'""></button><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.none" ng-click="_uncheckAll(filteredModel)" ng-bind-html="lang.selectNone" set-focus="kbFocus[kbFocusIndex] === \'none\'"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled" ng-if="helperStatus.reset" ng-click="fillShadowModel()" ng-bind-html="lang.reset" set-focus="kbFocus[kbFocusIndex] === \'reset\'"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{ lang.search }}" type="text"ng-model="searchInput.value" class="inputFilter" set-focus="kbFocus[kbFocusIndex] === \'input\'"/><button type="button" class="clearButton" ng-click="searchInput.value = \'\'" set-focus="kbFocus[kbFocusIndex] === \'clear\'">\u00d7</button> </div> </div> <div class="checkBoxContainer"><ul><li ng-repeat=\'item in filteredModel\' ng-include="\'angular-multi-select-item.htm\'"></li></ul></div></div></div></span>')}]);
