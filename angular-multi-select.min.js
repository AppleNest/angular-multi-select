var angular_multi_select=angular.module("angular-multi-select",["ng","angular.filter"]);
angular_multi_select.directive("angularMultiSelect",["$sce","$timeout","$filter",function(d,h,f){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"angular-multi-select.htm",link:function(a,m,c){a._shadowModel=[];a.filteredModel=[];a.searchInput={value:""};c.idProperty=c.idProperty||"angular-multi-select-id";c.selectionMode=c.selectionMode||"multi";c.selectionMode=
c.selectionMode.toLowerCase();a.helperStatus={all:"multi"===c.selectionMode,none:"multi"===c.selectionMode,reset:!0,filter:!0};a.kbFocus=[];a.kbFocusIndex=null;a.visible=!1;a.buttonLabel="";a.tickProperty=c.tickProperty;a.idProperty=c.idProperty;a.groupProperty=c.groupProperty;a.itemLabel=c.itemLabel;a._walk=function(b,c,g){if(angular.isArray(b)){var k=[];angular.forEach(b,function(b){b=a._walk(b,c,g);null!==b&&k.push(b)});return 0<k.length?k:null}if(angular.isObject(b)){g=g||function(){return!0};
var l=g(b);if(b.hasOwnProperty(c)&&angular.isArray(b[c])){var d=[];angular.forEach(b[c],function(b){b=a._walk(b,c,g);null!==b&&d.push(b)});d.length!==b[c].length&&(b[c]=d);l=0<d.length}return l?b:null}};a._syncModels=function(b,e){a._walk(e,c.groupProperty,function(e){a._walk(b,c.groupProperty,function(a){a[c.idProperty]===e[c.idProperty]&&(a[c.tickProperty]=e[c.tickProperty]);return!0});return!0})};a._enforceIDs=function(b){var e=[];a._walk(b,c.groupProperty,function(a){if(!1===a.hasOwnProperty(c.idProperty)||
-1!==e.indexOf(a[c.idProperty]))a[c.idProperty]=Math.floor(1E8*Math.random()+1);e.push(a[c.idProperty]);return!0})};a._getParent=function(b,e){var g=null,d=!1,l=null;a._walk(b,c.groupProperty,function(b){if(!0===d)return!0;0<a._hasChildren(b,!1)&&b[c.idProperty]!==e[c.idProperty]&&(l=b);b[c.idProperty]===e[c.idProperty]&&(g=l,d=!0);return!0});return g};a._getLeafs=function(b){var e=[];a._walk(b,c.groupProperty,function(b){0===a._hasChildren(b,!1)&&e.push(b);return!0});return e};a._getNodes=function(b){var e=
[];a._walk(b,c.groupProperty,function(b){0<a._hasChildren(b,!1)&&e.push(b);return!0});return e};a._hasChildren=function(b,e){if(!1===(e||!1)&&b.hasOwnProperty(c.groupProperty)&&angular.isArray(b[c.groupProperty])&&0<b[c.groupProperty].length)return 1;var d=-1;a._walk(b,c.groupProperty,function(){d++;return!0});return d};a._isChecked=function(a){return!(!a.hasOwnProperty(c.tickProperty)||!0!==a[c.tickProperty])};a._areAllChecked=function(b){var e=0,d=0;a._walk(b,c.groupProperty,function(b){0===a._hasChildren(b,
!1)&&(a._isChecked(b)&&e++,d++);return!0});return d===e?e:0<e?-e:0};a._enforceChecks=function(b){var e=0,d=a._getLeafs(b),k=!1;angular.forEach(d,function(d){!0!==k&&(a._isChecked(d)&&e++,1<e&&"single"===c.selectionMode&&(k=!0,a._uncheckAll(b)))});!0!==k&&(d=a._getNodes(b),angular.forEach(d,function(b){b[c.tickProperty]=0!==a._areAllChecked(b)}))};a._flipCheck=function(b){if(0<a._hasChildren(b)){var e=!(0<a._areAllChecked(b));a._walk(b,c.groupProperty,function(a){a[c.tickProperty]=e;return!0})}else b[c.tickProperty]=
!a._isChecked(b)};a._uncheckAll=function(b){a._walk(b,c.groupProperty,function(a){a[c.tickProperty]=!1;return!0})};a._checkAll=function(b){a._walk(b,c.groupProperty,function(a){return a[c.tickProperty]=!0})};a.clickItem=function(b){"single"!==c.selectionMode||0===a._areAllChecked(a._shadowModel)||(0===a._hasChildren(b,!1)||1===a._hasChildren(b))&&a._isChecked(b)||(a._uncheckAll(a._shadowModel),a._uncheckAll(a.filteredModel));a._flipCheck(b);a._enforceChecks(a.filteredModel);h(function(){a.onItemClick({data:angular.copy(b)})},
0)};a._filter=function(b){if(void 0===a.searchInput.value||""===a.searchInput.value)return!0;b=angular.extend({},b);b[c.itemLabel]=f("latinize")(b[c.itemLabel]);var e=a.searchInput.value,e=f("latinize")(e);return 0<f("fuzzyBy")([b],c.itemLabel,e).length};a.fillShadowModel=function(){a._shadowModel=angular.copy(a.inputModel);a._enforceIDs(a._shadowModel);a._enforceChecks(a._shadowModel);a.fillFilteredModel()};a.fillFilteredModel=function(){a.filteredModel=angular.copy(a._shadowModel);a.filteredModel=
a._walk(a.filteredModel,c.groupProperty,a._filter)};a.$watch("filteredModel",function(b){b&&(b=Math.abs(a._areAllChecked(a.filteredModel)),a.buttonLabel=b+" selected",a.buttonLabel=d.trustAsHtml(a.buttonLabel+'<span class="caret"></span>'),a._syncModels(a._shadowModel,a.filteredModel),a.outputModel=a._walk(angular.copy(a._shadowModel),c.groupProperty,function(b){a.kbFocus.push(b[c.idProperty]);return a._isChecked(b)}),a.kbFocus=[],!0===a.helperStatus.all&&a.kbFocus.push("all"),!0===a.helperStatus.none&&
a.kbFocus.push("none"),!0===a.helperStatus.reset&&a.kbFocus.push("reset"),!0===a.helperStatus.filter&&(a.kbFocus.push("input"),a.kbFocus.push("clear")),a._walk(a.filteredModel,c.groupProperty,function(b){a.kbFocus.push(b[c.idProperty]);return!0}))},!0);a.$watch("searchInput.value",function(b,c){angular.equals(b,c)||a.fillFilteredModel()});a.$watch("visible",function(b,d){angular.equals(b,d)||!0!==b?angular.equals(b,d)||!1!==b||(a.stopListeningMouseEvents(),a.stopListeningMouseEvents=null,a.stopListeningKeyboardEvents(),
a.stopListeningKeyboardEvents=null):(a.kbFocusIndex=a.kbFocus.indexOf("input")||0,a.stopListeningMouseEvents=a.$on("angular-multi-select-click",function(b,c){var d=!1;angular.forEach($(c.event.target).parents(),function(a){!0!==d&&void 0!==$(a).attr("angular-multi-select")&&(d=!0)});!1===d&&(a.visible=!1,a.$apply())}),a.stopListeningKeyboardEvents=a.$on("angular-multi-select-keydown",function(b,d){var e=d.event.keyCode?d.event.keyCode:d.event.which;if(27===e)a.visible=!1;else if(13===e||32===e){var f=
a.kbFocus[a.kbFocusIndex];angular.isNumber(f)&&a._walk(a.filteredModel,c.groupProperty,function(b){b[c.idProperty]===f&&a.clickItem(b);return!0})}else if(40===e||39===e||!d.event.shiftKey&&9==e)a.kbFocusIndex<a.kbFocus.length-1?a.kbFocusIndex++:a.kbFocusIndex=0;else if(38===e||37===e||d.event.shiftKey&&9==e)0<a.kbFocusIndex?a.kbFocusIndex--:a.kbFocusIndex=a.kbFocus.length-1;a.$apply()}))});a.fillShadowModel();a.lang={};a.directiveId=c.directiveId;"undefined"!==typeof c.maxHeight&&(m=m.children().children().children()[0],
angular.element(m).attr("style","height:"+c.maxHeight+"; overflow-y:scroll;"));a.icon={};a.icon.selectAll="&#10003;";a.icon.selectNone="&times;";a.icon.reset="&#8630;";a.icon.tickMark="&#10003;";"undefined"!==typeof c.translation?(a.lang.selectAll=d.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;"+a.translation.selectAll),a.lang.selectNone=d.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;"+a.translation.selectNone),a.lang.reset=d.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;"+a.translation.reset),a.lang.search=a.translation.search,
a.lang.nothingSelected=d.trustAsHtml(a.translation.nothingSelected)):(a.lang.selectAll=d.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;Select All"),a.lang.selectNone=d.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;Select None"),a.lang.reset=d.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;Reset"),a.lang.search="Search...",a.lang.nothingSelected="None Selected");a.icon.tickMark=d.trustAsHtml(a.icon.tickMark)}}}]);
angular_multi_select.directive("angularMultiSelectKeyTrap",function(){return function(d,h){h.bind("keydown",function(f){d.$broadcast("angular-multi-select-keydown",{event:f})})}});angular_multi_select.directive("angularMultiSelectMouseTrap",function(){return function(d,h){h.bind("click",function(f){d.$broadcast("angular-multi-select-click",{event:f})})}});
angular_multi_select.directive("setFocus",function(d){return function(h,f,a){h.$watch(a.setFocus,function(a){d(function(){a?f.focus():f.blur()})},!0)}});angular_multi_select.run(["$templateCache",function(d){d.put("angular-multi-select-item.htm","<div class='multiSelectItem' ng-click='clickItem(item);' ng-class='{selected: item[tickProperty], multiSelectGroup:_hasChildren(item, false) > 0, multiSelectFocus: kbFocus[kbFocusIndex] === item[idProperty]}'>{{ item[itemLabel] }}<span class=\"tickMark\" ng-if=\"item[tickProperty] === true\" ng-bind-html=\"icon.tickMark\"></span></div><ul ng-if='item.sub'><li ng-repeat='item in item[groupProperty]' ng-include=\"'angular-multi-select-item.htm'\" ></li></ul>")}]);
angular_multi_select.run(["$templateCache",function(d){d.put("angular-multi-select.htm",'<span class="multiSelect inlineBlock"><button id="{{directiveId}}" type="button"ng-click="visible = !visible"ng-bind-html="buttonLabel"ng-disabled="disable-button"></button><div class="checkboxLayer" ng-show="visible"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.all" ng-click="_checkAll(filteredModel)" ng-bind-html="lang.selectAll" set-focus="kbFocus[kbFocusIndex] === \'all\'""></button><button type="button" class="helperButton"ng-disabled="isDisabled" ng-if="helperStatus.none" ng-click="_uncheckAll(filteredModel)" ng-bind-html="lang.selectNone" set-focus="kbFocus[kbFocusIndex] === \'none\'"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled" ng-if="helperStatus.reset" ng-click="fillShadowModel()" ng-bind-html="lang.reset" set-focus="kbFocus[kbFocusIndex] === \'reset\'"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{ lang.search }}" type="text"ng-model="searchInput.value" class="inputFilter" set-focus="kbFocus[kbFocusIndex] === \'input\'"/><button type="button" class="clearButton" ng-click="searchInput.value = \'\'" set-focus="kbFocus[kbFocusIndex] === \'clear\'">\u00d7</button> </div> </div> <div class="checkBoxContainer"><ul><li ng-repeat=\'item in filteredModel\' ng-include="\'angular-multi-select-item.htm\'"></li></ul></div></div></div></span>')}]);
